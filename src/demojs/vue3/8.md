---
title: piniaä½¿ç”¨
# icon: object-group
order: 8
category:
    - å­¦ä¹ è®°å½•
tag:
    - vue3
    - pinia
---

# 8. pinia ä½¿ç”¨

### 8.1 pinia ä½¿ç”¨

[pinia æ–‡æ¡£](https://pinia.vuejs.org/zh/introduction.html)

> Pinia æ˜¯ Vue 3 çš„å®˜æ–¹çŠ¶æ€ç®¡ç†å·¥å…·ï¼Œæ˜¯ Vuex çš„å‡çº§ç‰ˆï¼Œæä¾›æ›´ç®€å•çš„ API å’Œæ›´å¥½çš„ TypeScript æ”¯æŒã€‚

---

##### 8.1.1 **å®‰è£… pinia**

```bash
# npmå®‰è£…
npm i pinia -S
# yarnå®‰è£…
yarn add pinia -S
```

---

##### 8.1.2 **åœ¨ main.js ä¸­æ³¨å†Œ pinia**

```javascript
// main.js
import { createApp } from "vue"
import { createPinia } from "pinia" // å¯¼å…¥ pinia
import App from "./App.vue"

const app = createApp(App)
const pinia = createPinia() // åˆ›å»º pinia å®ä¾‹

app.use(pinia) // æ³¨å†Œ pinia
app.mount("#app")
```

---

##### 8.1.3 **åˆ›å»º store**

> Pinia æ”¯æŒä¸¤ç§é£æ ¼çš„ store å®šä¹‰ï¼š
>
> 1. é€‰é¡¹å¼ï¼ˆOptions Storeï¼‰ï¼šç±»ä¼¼ Vuex çš„å†™æ³•ï¼Œç»“æ„æ¸…æ™°
> 2. ç»„åˆå¼ï¼ˆSetup Storeï¼‰ï¼šä½¿ç”¨ç»„åˆå¼ APIï¼Œæ›´çµæ´»
>
> ç‰¹ç‚¹ï¼š
>
> -   ä½¿ç”¨ `defineStore` åˆ›å»º store
> -   è‡ªå¸¦æ¨¡å—åŒ–ï¼Œæ— éœ€åƒ Vuex é‚£æ ·é…ç½® modules
> -   å»æ‰äº† mutationsï¼Œåªä¿ç•™ stateã€gettersã€actions

###### é€‰é¡¹å¼ storeï¼ˆæ¨èï¼‰

```javascript
// store/counter.js
import { defineStore } from "pinia"

export const useCounterStore = defineStore("counter", {
    // å®šä¹‰çŠ¶æ€
    state: () => ({
        count: 0,
        name: "è®¡æ•°å™¨",
    }),

    // ç±»ä¼¼è®¡ç®—å±æ€§
    getters: {
        doubleCount: (state) => state.count * 2,
        // ä½¿ç”¨ this è®¿é—® state
        countText() {
            return `å½“å‰æ•°å€¼ï¼š${this.count}`
        },
    },

    // å®šä¹‰ä¸šåŠ¡é€»è¾‘
    actions: {
        increment() {
            this.count++
        },
        async fetchCount() {
            const res = await api.getCount()
            this.count = res.data
        },
    },
})
```

###### ç»„åˆå¼ store

```javascript
// store/counter.js
import { defineStore } from "pinia"
import { ref, computed } from "vue"

export const useCounterStore = defineStore("counter", () => {
    // çŠ¶æ€
    const count = ref(0)
    const name = ref("è®¡æ•°å™¨")

    // è®¡ç®—å±æ€§
    const doubleCount = computed(() => count.value * 2)

    // æ–¹æ³•
    function increment() {
        count.value++
    }

    async function fetchCount() {
        const res = await api.getCount()
        count.value = res.data
    }

    return {
        count,
        name,
        doubleCount,
        increment,
        fetchCount,
    }
})
```

---

##### 8.1.4 **ç»„ä»¶ä¸­ä½¿ç”¨ pinia**

```javascript
<template>
  <div class="counter">
    <h2>{{ store.name }}</h2>
    <p>Count: {{ store.count }}</p>
    <p>Double: {{ store.doubleCount }}</p>

    <div class="buttons">
      <el-button type="primary" @click="increment">
        å¢åŠ 
      </el-button>
      <el-button type="warning" @click="reset">
        é‡ç½®
      </el-button>
    </div>
  </div>
</template>

<script setup>
import { useCounterStore } from '../stores/counter'
import { storeToRefs } from 'pinia'

const store = useCounterStore()

// ğŸš¨ é”™è¯¯ç¤ºèŒƒï¼šç›´æ¥è§£æ„ä¼šå¤±å»å“åº”æ€§
// const { count, name } = store

// âœ… æ­£ç¡®æ–¹å¼1ï¼šä½¿ç”¨ storeToRefs
const { count, name } = storeToRefs(store)

// âœ… æ­£ç¡®æ–¹å¼2ï¼šä½¿ç”¨è®¡ç®—å±æ€§
const doubleCount = computed(() => store.doubleCount)

// ä¿®æ”¹çŠ¶æ€çš„å‡ ç§æ–¹å¼
const increment = () => {
    // 1. ç›´æ¥è°ƒç”¨ action
    store.increment()

    // 2. ä½¿ç”¨ $patch ä¿®æ”¹å¤šä¸ªçŠ¶æ€
    store.$patch({
        count: store.count + 1,
        name: 'æ–°è®¡æ•°å™¨'
    })

    // 3. ä½¿ç”¨ $patch å‡½æ•°å½¢å¼
    store.$patch((state) => {
        state.count++
        state.name = 'æ–°è®¡æ•°å™¨'
    })
}

const reset = () => {
    // é‡ç½®çŠ¶æ€åˆ°åˆå§‹å€¼
    store.$reset()
}

// è®¢é˜…çŠ¶æ€å˜åŒ–
store.$subscribe((mutation, state) => {
    console.log('çŠ¶æ€å˜åŒ–ï¼š', mutation.type, mutation.payload)
})

// è®¢é˜… action
store.$onAction(({
    name, // action åç§°
    store, // store å®ä¾‹
    args, // ä¼ å…¥çš„å‚æ•°
    after, // åœ¨ action å®Œæˆåæ‰§è¡Œ
    onError // åœ¨ action æŠ¥é”™æ—¶æ‰§è¡Œ
}) => {
    console.log(`Action ${name} è¢«è°ƒç”¨`)

    after((result) => {
        console.log(`Action ${name} å®Œæˆ`)
    })

    onError((error) => {
        console.error(`Action ${name} æŠ¥é”™ï¼š`, error)
    })
})
</script>
```

---

##### 8.1.5 **pinia æŒä¹…åŒ–**

1. **å®‰è£…æ’ä»¶**
   å› ä¸ºæˆ‘çš„ node ç‰ˆæœ¬æ˜¯ 18.4.0ï¼Œåªèƒ½å®‰è£… 2.x ç‰ˆæœ¬çš„
   pinia-plugin-persistedstateã€‚æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ã€‚

```bash
npm i pinia-plugin-persistedstate@2.1.0
# æˆ–
yarn add pinia-plugin-persistedstate@2.1.0
```

2. **æ³¨å†Œæ’ä»¶**

```javascript
// main.js
import { createPinia } from "pinia"
import piniaPluginPersistedstate from "pinia-plugin-persistedstate"

const pinia = createPinia()
pinia.use(piniaPluginPersistedstate)
```

3. **åœ¨ store ä¸­é…ç½®æŒä¹…åŒ–**

```javascript
// é€‰é¡¹å¼å†™æ³•
export const useCounterStore = defineStore("counter", {
    state: () => ({
        count: 0,
        name: "è®¡æ•°å™¨",
        settings: {
            theme: "light",
            language: "zh-CN",
        },
    }),
    persist: {
        key: "counter-store", // å­˜å‚¨çš„key
        storage: localStorage, // å­˜å‚¨æ–¹å¼
        paths: ["count", "settings"], // æŒ‡å®šè¦æŒä¹…åŒ–çš„å­—æ®µ
    },
})

// ç»„åˆå¼å†™æ³•
export const useCounterStore = defineStore(
    "counter",
    () => {
        // store é€»è¾‘
    },
    {
        persist: true, // å¼€å¯æŒä¹…åŒ–
    }
)
```

### 8.2 vue3 ä½¿ç”¨ vuex (ä¸æ¨è)

> è™½ç„¶ Vuex 4.x æ”¯æŒ Vue 3ï¼Œä½†å®˜æ–¹æ¨èä½¿ç”¨ Piniaã€‚

1. **å®‰è£…**

```bash
npm install vuex@next --save
```

2. **åˆ›å»º store**

```javascript
// store/index.js
import { createStore } from "vuex"

export default createStore({
    state: {
        count: 0,
    },
    mutations: {
        INCREMENT(state) {
            state.count++
        },
    },
    actions: {
        increment({ commit }) {
            commit("INCREMENT")
        },
    },
    getters: {
        doubleCount: (state) => state.count * 2,
    },
})
```

3. **æ³¨å†Œ store**

```javascript
// main.js
import { createApp } from "vue"
import store from "./store"
import App from "./App.vue"

const app = createApp(App)
app.use(store)
app.mount("#app")
```

4. **ç»„ä»¶ä¸­ä½¿ç”¨**

```javascript
<template>
  <div>
    <p>Count: {{ count }}</p>
    <p>Double: {{ doubleCount }}</p>
    <button @click="increment">å¢åŠ </button>
  </div>
</template>

<script setup>
import { computed } from 'vue'
import { useStore } from 'vuex'

const store = useStore()

// è·å–çŠ¶æ€
const count = computed(() => store.state.count)
const doubleCount = computed(() => store.getters.doubleCount)

// ä¿®æ”¹çŠ¶æ€
const increment = () => {
    store.dispatch('increment')
}
</script>
```

### 8.3 Pinia vs Vuex å¯¹æ¯”

| ç‰¹æ€§            | Pinia                        | Vuex 4.x                      |
| --------------- | ---------------------------- | ----------------------------- |
| Vue 3 æ”¯æŒ      | âœ… åŸç”Ÿæ”¯æŒ                  | âš ï¸ éœ€è¦ä½¿ç”¨ Vuex 4.x          |
| TypeScript æ”¯æŒ | âœ… å®Œæ•´æ”¯æŒï¼Œè‡ªåŠ¨ç±»å‹æ¨å¯¼    | âš ï¸ éƒ¨åˆ†æ”¯æŒï¼Œéœ€è¦æ‰‹åŠ¨ç±»å‹å£°æ˜ |
| å¼€å‘å·¥å…·        | âœ… Vue DevTools å®Œæ•´æ”¯æŒ     | âœ… Vue DevTools å®Œæ•´æ”¯æŒ      |
| ä»£ç ç»“æ„        | âœ… æ›´ç®€å•ï¼Œæ— éœ€ mutations    | âš ï¸ éœ€è¦ mutations ä¸­è½¬        |
| æ¨¡å—åŒ–          | âœ… è‡ªåŠ¨æ¨¡å—åŒ–ï¼Œæ— éœ€é…ç½®      | âš ï¸ éœ€è¦æ‰‹åŠ¨é…ç½® modules       |
| æ€§èƒ½            | âœ… æ›´å¥½ï¼ˆä»£ç åˆ†å‰²ã€TS æ”¯æŒï¼‰ | âš ï¸ ç›¸å¯¹è¾ƒå·®                   |
| è°ƒè¯•èƒ½åŠ›        | âœ… æ›´å¼ºï¼ˆç›´æ¥è¿½è¸ªçŠ¶æ€å˜åŒ–ï¼‰  | âš ï¸ éœ€è¦é€šè¿‡ mutations è¿½è¸ª    |
| å­¦ä¹ æ›²çº¿        | âœ… ç®€å•ç›´è§‚                  | âš ï¸ æ¦‚å¿µè¾ƒå¤š                   |

#### ä¸ºä»€ä¹ˆé€‰æ‹© Piniaï¼Ÿ

1. **æ›´ç®€å•çš„ API**

    - æ— éœ€ mutationsï¼Œç›´æ¥ä¿®æ”¹çŠ¶æ€
    - è‡ªåŠ¨æ¨¡å—åŒ–ï¼Œæ— éœ€é…ç½®
    - API è®¾è®¡æ›´ç¬¦åˆç›´è§‰

2. **æ›´å¥½çš„ TypeScript æ”¯æŒ**

    - è‡ªåŠ¨ç±»å‹æ¨å¯¼
    - å®Œæ•´çš„ IDE æ”¯æŒ
    - æ›´å°‘çš„ç±»å‹å£°æ˜ä»£ç 

3. **æ›´å¥½çš„å¼€å‘ä½“éªŒ**

    - ä»£ç æ›´ç®€æ´
    - è°ƒè¯•æ›´æ–¹ä¾¿
    - æ€§èƒ½æ›´å¥½

4. **æ›´ç°ä»£çš„ç‰¹æ€§**
    - ç»„åˆå¼ API æ”¯æŒ
    - è‡ªåŠ¨ä»£ç åˆ†å‰²
    - æ›´å¥½çš„æ‰©å±•æ€§

#### ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ Vuexï¼Ÿ

1. **ç»´æŠ¤è€é¡¹ç›®**

    - å·²æœ‰çš„ Vue 2 é¡¹ç›®
    - å›¢é˜Ÿç†Ÿæ‚‰ Vuex
    - è¿ç§»æˆæœ¬è€ƒè™‘

2. **ç‰¹æ®Šéœ€æ±‚**
    - éœ€è¦ä¸¥æ ¼çš„çŠ¶æ€å˜æ›´è¿½è¸ª
    - ç‰¹å®šçš„æ’ä»¶ç”Ÿæ€éœ€æ±‚

> ğŸ’¡ **å»ºè®®**ï¼š
>
> -   æ–°é¡¹ç›®å»ºè®®ç›´æ¥ä½¿ç”¨ Pinia
> -   è€é¡¹ç›®å¯ä»¥æ¸è¿›å¼è¿ç§»åˆ° Pinia
> -   Pinia å’Œ Vuex å¯ä»¥å…±å­˜ï¼Œæ–¹ä¾¿æ¸è¿›å¼è¿ç§»
